name: Keploy API Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  test:
    runs-on: windows-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Desktop
        uses: docker/setup-buildx-action@v3
        with:
          platforms: windows/amd64
          install: true

      - name: Install Docker Compose
        run: |
          choco install docker-compose -y
        shell: powershell

      - name: Switch to Windows containers
        run: |
          Write-Host "üîÑ Switching to Windows containers..."
          & $Env:ProgramFiles\Docker\Docker\DockerCli.exe -SwitchDaemon
        shell: powershell

      - name: Build and start containers
        run: |
          Write-Host "üèóÔ∏è Building containers..."
          docker compose build --no-cache
          docker compose up -d todo-api
          Write-Host "‚è≥ Waiting for services to be ready..."
          Start-Sleep -Seconds 30
        shell: powershell

      - name: Record test cases
        run: |
          Write-Host "üî¥ Starting test recording..."
          docker compose run --rm test python test_api_with_keploy.py
          Write-Host "‚úÖ Test recording completed"
        shell: powershell

      - name: Run Keploy tests
        if: env.KEPLOY_API_KEY != ''
        env:
          KEPLOY_API_KEY: ${{ secrets.KEPLOY_API_KEY }}
        run: |
          Write-Host "üß™ Running Keploy tests..."
          if ($env:KEPLOY_API_KEY) {
            docker compose run --rm test bash -c "export KEPLOY_API_KEY=$env:KEPLOY_API_KEY && keploy test-suite --app=9d09b06a-70f5-443d-871e-47134856f411 --base-path https://github.com/HemrajShelke/todo-api.git --cloud"
          } else {
            Write-Host "‚ö†Ô∏è Skipping Keploy tests - API key not configured"
          }
        shell: powershell

      - name: Upload Keploy test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: keploy-test-results
          path: |
            backend/test_results/
            backend/keploy/
          retention-days: 30

      - name: Generate test summary
        if: always()
        run: |
          Write-Host "üìä Test Summary:"
          Write-Host "==============="
          Write-Host "‚úÖ Docker environment setup"
          Write-Host "‚úÖ Services started successfully"
          Write-Host "‚úÖ Test cases recorded"
          if ($env:KEPLOY_API_KEY) {
            Write-Host "‚úÖ Keploy tests executed"
          } else {
            Write-Host "‚ö†Ô∏è Keploy tests skipped - API key not configured"
          }
          Write-Host ""
          Write-Host "üìà Check the uploaded artifacts for detailed test results"
          Write-Host "üîó Keploy Dashboard: https://keploy.io"
        shell: powershell

      - name: Cleanup
        if: always()
        run: |
          Write-Host "üßπ Cleaning up..."
          docker compose down
          Write-Host "‚úÖ Cleanup completed"
        shell: powershell
