name: Keploy API Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggering

env:
  PYTHON_VERSION: '3.11'
  DOCKER_BUILDKIT: 1

jobs:
  test:
    runs-on: windows-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Desktop
        uses: docker/setup-buildx-action@v3
        with:
          platforms: windows/amd64

      - name: Switch to Windows containers
        run: |
          Write-Host "ğŸ”„ Switching to Windows containers..."
          & $Env:ProgramFiles\Docker\Docker\DockerCli.exe -SwitchDaemon

      - name: Build and start containers
        shell: pwsh
        run: |
          Write-Host "ğŸ—ï¸ Building containers..."
          docker-compose build --no-cache
          docker-compose up -d todo-api
          Write-Host "â³ Waiting for services to be ready..."
          Start-Sleep -Seconds 30

      - name: Record test cases
        shell: pwsh
        run: |
          Write-Host "ğŸ”´ Starting test recording..."
          docker-compose run --rm test python test_api_with_keploy.py
          Write-Host "âœ… Test recording completed"

      - name: Run Keploy tests
        if: env.KEPLOY_API_KEY != ''
        env:
          KEPLOY_API_KEY: ${{ secrets.KEPLOY_API_KEY }}
        shell: pwsh
        run: |
          Write-Host "ğŸ§ª Running Keploy tests..."
          if ($env:KEPLOY_API_KEY) {
            docker-compose run --rm test bash -c "export KEPLOY_API_KEY=$env:KEPLOY_API_KEY && keploy test-suite --app=9d09b06a-70f5-443d-871e-47134856f411 --base-path https://github.com/HemrajShelke/todo-api.git --cloud"
          } else {
            Write-Host "âš ï¸ Skipping Keploy tests - API key not configured"
          }

      - name: Upload Keploy test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: keploy-test-results
          path: |
            backend/test_results/
            backend/keploy/
          retention-days: 30

      - name: Generate test summary
        if: always()
        shell: pwsh
        run: |
          Write-Host "ğŸ“Š Test Summary:"
          Write-Host "==============="
          Write-Host "âœ… Docker environment setup"
          Write-Host "âœ… Services started successfully"
          Write-Host "âœ… Test cases recorded"
          if ($env:KEPLOY_API_KEY) {
            Write-Host "âœ… Keploy tests executed"
          } else {
            Write-Host "âš ï¸ Keploy tests skipped - API key not configured"
          }
          Write-Host ""
          Write-Host "ğŸ“ˆ Check the uploaded artifacts for detailed test results"
          Write-Host "ğŸ”— Keploy Dashboard: https://keploy.io"

      - name: Cleanup
        if: always()
        shell: pwsh
        run: |
          Write-Host "ğŸ§¹ Cleaning up..."
          docker-compose down
          Write-Host "âœ… Cleanup completed"
